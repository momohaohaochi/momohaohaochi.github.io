---
title: 数据库设计
date: '2019-11-22 00:00:00'
tags:
- Database
---

# 数据库设计

为了有效的存储，和高效的运行。

| 优良的设计       | 糟糕的设计                   |
| ---------------- | ---------------------------- |
| 减少数据冗余     | 存在大量数据冗余             |
| 避免数据维护异常 | 存在数据插入，更新，删除异常 |
| 节约存储空间     | 浪费大量存储空间             |
| 高效的访问       | 访问数据低效                 |

## 数据库设计步骤

需求分析 → 逻辑设计 → 物理设计 → 维护优化

### 需求分析

#### 为什么要进行数据分析？

1. 了解系统中所要存储的数据

2. 了解数据的存储特点

   例如数据的时效性，对有时效性的数据需要定期清理等

3. 了解数据的生命周期

   日志记录不适合存储到数据库，增长量大，非核心数据，需要首先制定清理规则

#### 要搞清楚的一些问题

1. 实体及实体之间的关系（1 对 1，1 对多，多对多）
2. 实体包含的属性有什么？
3. 哪些属性或属性的组合可以唯一标识一个实体

#### 实例演示

以一个小型电子商务网站为例，包含几个核心模块：**用户模块**，**商品模块**，**订单模块**，**购物车模块**，**供应商模块**。

##### 用户模块

用于记录注册用户信息

- 包含属性：用户名，密码，电话，邮箱，身份证号，地址，姓名，昵称……
- 可选唯一标识属性：用户名，身份证，电话
- 存储特点：随系统上线时间逐渐增加，需要永久存储，不需要删除和归档（归档：将不常用的数据迁移到另一个数据库表或磁盘中），需要提前考虑分库分表的问题

##### 商品模块

用于记录网站中所销售的商品信息

- 包含属性：商品编码，商品名称，商品描述，商品描述，商品类，供应商名称，重量，有效期，价格……
- 可选唯一标识属性：（商品名称，供应商名称），商品编码
- 存储特点：对于下线商品可以归档存储（如果供应商不在对某一商品提供供应，但是该商品可能在订单表中使用，所以不能删除该产品，可以将这些下线商品移动到另一个库表中，使得当前库表的查询等高效）

##### 订单模块

用于用户订购商品的信息

- 包含属性：订单号，用户姓名，用户电话，收货地址，商品编号，商品名称，数量，价格，订单状态，支付类型，订单类型……
- 可选唯一标识属性：订单号
- 存储特点：永久存储（分表，分库存储）

##### 购物车模块

用于保存用户购物时选购的商品

- 包含属性：用户名，商品编号，商品名称，商品价格，商品描述，商品分类，加入时间，商品数量……
- 可选唯一标识属性：（用户名，商品编号，加入时间），购物车编号
- 存储特点：不用永久存储（设置归档，清理规则）

##### 供应商模块

用于保存所销售商品的供应商信息

- 包含属性：供应商编号，供应商名称，联系人，电话，营业执照号，地址，法人……
- 可选唯一标识属性：供应商编号，营业执照号
- 存储特点：永久存储

##### 对应关系

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194332.png)


![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194348.png)

### 逻辑设计

1. 将需求转化为数据库的逻辑模型
2. 通过 ER 图（Entity Relationship Diagram）的形式对逻辑模型进行展示
3. 同所选用的具体 DBMS（DataBase Manager System）无关

#### 名词解释

**关系**：一个关系对应通常所说的一张表

**元组**：表中的一行即为一个元组

**属性**：表中的一列即为一个属性

**候选码**：表中的某个属性组，可以唯一确定一个元组

**主码**：一个关系有多个候选码，选定其中一个为主码

**域**：属性的取值范围

**分量**：元组中的属性值

#### ER 图例说明

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194718.png)

#### 实例 ER 图

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194733.png)

菱形（关系级），可以将**多对多**的关系转换成 **1 对多**的关系，例如**选购**关系
在椭圆（属性）下添加**下划线**，表示该属性是一个**主码**

#### 设计范式概要

常见的数据库设计范式

- 第一范式
- 第二范式
- 第三范式
- BC 范式

其他范式

- 第四范式
- 第五范式

##### 数据操作异常及数据冗余

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194758.png)

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194815.png)

##### 第一范式（1NF）

定义：数据库表中的所有字段都是单一属性，不可再分的，这个单一属性是由基本的数据类型所构成的，如整数，浮点数，字符串等
换句话说：第一范式要求数据库中的表都是二维表

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194839.png)

##### 第二范式（2NF）

定义：数据库的表中不存在非关键字段对任一候选关键字段的部分函数依赖。部分函数依赖是指存在着组合关键字的某一关键字决定非关键字的情况

换句话说：所有单关键字段的表都符合第二范式

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194859.png)

**存在的问题**

- 插入异常
  如果该表中不包含饮料一厂提供的产品，则无法在插入饮料一厂产品时，获取到饮料一厂的信息
- 删除异常
  如果把饮料一厂提供的产品信息删除掉，则在该表中找不到任何关于饮料一厂的信息
- 更新异常
  如果饮料一厂提供了多种商品，在更新饮料一厂的电话时，会更新多条数据
- 数据冗余
  如果饮料一厂提供了多个商品，则会有多条饮料一厂的电话，造成数据冗余

**解决方法**

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194918.png)

##### 第三范式（3NF）

定义：第三范式是在第二范式的基础之上定义的，如果数据表中不存在非关键字段对任一候选关键字段的传递函数依赖则符合第三范式。

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194933.png)

**存在的问题**

- 插入异常
  如果酒水饮料没有任何商品，则在插入新酒水饮料数据时，查询不到酒水饮料的分类描述等信息
- 删除异常
  如果删除了酒水饮料下的所有产品，则查询不到酒水饮料的任何信息
- 更新异常 更新酒水饮料的分类描述时，会更新多条分类描述
- 数据冗余
  如果有多个酒水饮料，则会有多条相同的分类，分类描述信息。

**解决方法**

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222194951.png)

##### Boyce.Codd 范式（BCNF）

定义：在第三范式的基础上，数据库表中如果不存在任何字段对任一候选关键字段的传递函数依赖则符合 BC 范式。

也就是说：如果是复合关键字，则复合关键字之间也不能存在函数依赖关系

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195007.png)

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195027.png)



**存在的问题**

- 插入异常
  如果饮料二厂没有任何商品，则在插入饮料二厂提供的商品数据时，查询不到饮料二厂的各种信息
- 删除异常
  如果删除了饮料二厂的所有商品，则查询不到饮料二厂的任何信息
- 更新异常 如果饮料一厂有多个供应商联系人，在更新时，会更新出错
- 数据冗余
  如果有多个商品都是饮料一厂的同一个供应商联系人，则会造成数据冗余

**解决方法**

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195044.png)

### 物理设计

1. 选择合适的数据库管理系统。

   ![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210603094551.png)

2. 定义数据库，表及字段的命名规范。

3. 根据所选的 DBMS 系统选择合适的字段类型。

4. 反范式化设计。

#### MySQL 常用的存储引擎

| 存储引擎              | 事物   | 锁粒度               | 主要应用             | 忌用                     | 备注                                                         |
| --------------------- | ------ | -------------------- | -------------------- | ------------------------ | ------------------------------------------------------------ |
| MyISAM（5.5 之前默认）| 不支持 | 支持并发插入的表级锁 | 读多写少             | 写操作频繁               | 读取快                                                       |
| MRG_MYISAM            | 不支持 | 支持并发插入的表级锁 | 分段归档，数据仓库   | 全局查找过多的场景       | 将多个结构相同的 MyISAM 表合并成一个表处理，类似于视图，分区的功能 |
| Innodb（5.5 之后默认）| 支持   | 支持 MVCC 的行级锁     | 事务处理             | 无                       | MVCC：Multi-Version Concurrency Control 多版本并发控制       |
| Archive               | 不支持 | 行级锁               | 只支持 insert，select | 需要随机读取，更新，删除 | 适合日志记录，存储数据占用空间较小                           |
| Ndb cluster           | 支持   | 行级锁               | 高可用性             | 大部分应用               | MySQL 集群时使用，大部分数据放到内存中，数据量较大不适合      |

#### 表及字段的命名规则

1. 可读性原则

   使用大写和小写来格式化的库对象名以获得良好的可读性。

   例如：使用 cust_address 而不是 custaddress 来提高可读性。（注意 DBMS 系统对表名的大小写敏感性）

2. 表意性原则

   对象的名字应该能够描述他所标识的对象。

   例如：对于表，表的名称应该能够体现表中存储的数据内容；对于存储过程，存储过程名称应该能够体现存储过程的功能。

3. 长名原则

   尽可能少使用或不使用缩写

   适用于数据库名之外的任一对象。

#### 字段类型的选择原则

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195120.png)

1. 在对数据进行比较（查询条件，JOIN 条件及排序）操作时，同样的数据，字符串处理往往比数字处理慢。
2. 在数据库中，数据处理是以页为单位的，列的长度越小，利于性能提升。

##### MySQL 数据类型占用空间

![img](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195134.png)

`TimeStamp` 使用 `Int` 来存储，最多存储到 2037 年

##### 具体的选择方式

![image-20210222195213406](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195213.png)

![image-20210222195230708](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195231.png)

![image-20210222195250070](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195250.png)

只存储年可以使用 Year 类型

##### 其他注意事项

###### 如何选择主键

![image-20210222195305084](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195305.png)

###### 避免使用外键约束

1. 降低数据导入的效率
2. 增加维护成本
3. 虽然不建议使用外键约束，但是相关联的列上一定要建立索引

###### 避免使用触发器

1. 降低数据导入的效率
2. 可能会出现意想不到的数据异常
3. 使业务逻辑变复杂

###### 关于预留字段

1. 无法准确的知道预留字段类型
2. 无法准确的知道预留字段中所存储的内容
3. 后期维护预留字段所要的成本，同增加一个字段所需要的成本是相同的
4. 严禁使用预留字段

#### 反范式化

![image-20210222195534331](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195534.png)

##### 符合范式化的设计

![image-20210222195543742](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195544.png)

**查询订单信息**

```mysql
SELECT 
    b.用户名, b.电话, b.地址, a.订单 ID, SUM(c.商品价格 * c.商品数量) as 订单价格
FROM 
    订单表 a
    JOIN 用户表 b ON a.用户 ID = b.用户 ID 
    JOIN 订单商品表 c ON c.订单 ID = b.订单 ID
GROUP BY 
    b.用户名, b.电话, b.地址, a.订单 ID;
```

##### 反范式化的设计

![image-20210222195603786](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195604.png)

**查询订单信息**

```mysql
SELECT 
    b.用户名, b.电话, b.地址, a.订单 ID, c.商品名称, c.过期时间, c.商品数量, c.商品价格 
FROM 
    订单表 a 
    JOIN 用户表 b ON a.用户 ID = b.用户 ID 
    JOIN 订单商品表 c ON c.订单 ID = b.订单 ID;
```

##### 反范式化的好处

1. 减少表的关联数量
2. 增加数据的读取效率
3. 反范式化一定要适度

### 维护优化

#### 维护数据字典

1. 使用第三方工具对数据字典进行维护

2. 利用数据本身的备注字段来维护数据字典

   以 MySQL 为例

   ```mysql
   CREATE TABLE customer(
       cust_id INT A 标签，例如 spring-boot javaUTO_INCREMENT NOT NULL COMMENT '自增 ID',
       cust_name VARCHAR(10) NOT NULL COMMENT '客户姓名',
       PRIMARY KEY (cust_id)
   ) COMMENT '客户表'
   ```

3. 导出数据字典

   ```mysql
   SELECT 
       a.table_name, b.TABLE_COMMENT, a.COLUMN_NAME, a.COLUMN_TYPE, a.COLUMN_COMMENT 
   FROM 
       information_schema.COLUMNS a 
       JOIN information_schema.TABLES b 
       ON a.table_schema = b.table_schema 
   AND 
       a.table_name = b.table_name
   WHERE 
       a.table_name = 'customer';
   ```

MySQL 的元数据信息均存储在了 information_schema 数据库下的表中

#### 维护索引

##### 如何选择合适的列建立索引?

1. 出现在 WHERE 从句，GROUP BY 从句，ORDER BY 从句中的列
2. 可选择性高的列要放在索引的前面
3. 索引中不要包括太长的数据类型

##### 注意事项

1. 索引并不是越多越好，过多的索引不但会降低写的效率，而且会降低读的效率
2. 定期维护索引碎片
3. 在 SQL 语句中不要使用强制索引关键字

#### 维护表结构

##### 注意事项

1. 使用在线变更表结构的工具
   - MySQL5.5 之前会锁表，可以使用 pt-online-schema-change 工具，会将源数据库表中的数据赋值到临时表，然后对临时表进行修改，注意原表中不能包含触发器，因为该工具会对表添加三个触发器（删除，插入，更新），MySQL 一个表中只能含有一个同类触发器
   - MySQL5.6 之后本身支持在线表结构的变更
2. 同时对数据字典进行维护
3. 控制表的宽度和大小

##### 数据库中适合的操作

1. 批量操作
2. 禁止使用 `SELECT *` 这样的查询
3. 控制使用用户自定义函数
4. 不要使用数据库中的全文索引

#### 在适当的时候对表进行水平拆分或垂直拆分

##### 表的垂直拆分

为了控制表的宽度可以进行表的垂直拆分

![image-20210222195637130](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195637.png)

1. 经常一起查询的列放在一起
2. text，blob 等大字段拆分到附加表中

##### 表的水平拆分

为了控制表的大小可以进行表的水平拆分

![image-20210222195652715](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195653.png)

通过主键 HASH 的方式拆分

![image-20210222195707321](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210222195707.png)

## 参考视频

[数据库设计那些事](https://www.imooc.com/learn/117)
