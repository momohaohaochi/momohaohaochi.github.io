---
title: 进阶-TCP/IP协议及OSI七层模型
date: '2020-06-09 22:42:39'
tags:
- Linux
categories:
- Linux
- 阿里云Linux运维学习路线
- 阶段二:网络基础
---

# 进阶-TCP/IP协议及OSI七层模型

## OSI参考模型(open system interface)

### 封包过程:

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235701.png)

- A, P, S, T, N, D: 报文首部
- CRC: 根据首部计算出的校验位

### 解包过程

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235702.png)

## 冲突检测的载波侦听多路访问CSMA/CD

在早期的10M带宽的网络中使用, 现在已不在使用

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235704.png)

- 使用的是总线形拓扑结构, 当发送数据时, 先监听总线中如果没有正在传输数据, 才进行传输.
- 如果有多台机器同时发送了数据, 会造成数据碰撞, 进而损坏数据.
- 使用回退算法生成一个等待时间, 然后再发送数据. 此时成功与否也是不确定的.

## Hub集线器

因为电缆传输的物理信号强度会随着距离的增大而减弱, 所以可以使用中继器将两个电缆连接到一起, 进而达到放大信号, 增加传输距离的目的.

常用电缆物理信号最大传输距离: 
- 细缆: 185m
- 粗缆: 500m
- 双绞线: 100m

Hub: 多端口中继器, 工作在物理层

Hub并不记忆该信息包是由哪个MAC地址发出, 哪个MAC地址在Hub的哪个端口. 向所有连接在其上的机器均发送数据包

特点: 
- 共享带宽
- 半双工

冲突域: 如果两台机器同时向网络中发送数据会发生冲突, 则说这两台机器在同一个冲突域中.

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235705.png)

## 以太网桥和交换机(switch)

一般只有两个接口, 而交换机有多个端口. 网桥是半双工的, 交换机是全双工的. 两者均工作在数据链路层

### 交换式以太网的优势

- 扩展了网络带宽
- 分割了网络冲突域, 使网络冲突被限制在最小的范围内
- 交换机作为更加智能的交换设备, 能够提供更多用户所要求的功能: 优先级, 虚拟网, 远程检测...

### 以太网桥的工作原理

- 以太网桥监听数据帧中源MAC地址, 学习MAC, 建立MAC表
- 对于未知的MAC地址, 网桥将转发到除接收该帧的端口之外的所有端口
- 当网桥接到一个数据帧时, 如果该帧的目的位于接收端口所在的网端上, 他就过滤掉该数据帧; 如果目的MAC地址在位于另外一个端口, 网桥就将该帧转发到该端口
- 当网桥接到广播帧的时候, 他立即转发到除接收端口之外的所有其他端口(即不能隔断广播域: 当一个主机向外发送广播, 而另一个机器收到该广播消息, 则说这两个机器在同一个广播域.)

A机器向B机器发送数据包

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235706.png)

网桥将A的MAC地址及其所在端口记录到MAC地址表中

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235707.png)


B回应数据包, 网桥会将B的MAC地址及其端口添加到MAC地址表中

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235708.png)

当A向B再次发送数据时, 网桥会根据MAC地址表找到对应的端口, 此时不在将数据包向C和D发送, 使得上下两部分网络分割开来, 达到分割冲突域的目的, 将四个机器形成的冲突域分割成两个由2台机器构成的冲突域, 减少了冲突域中机器的数量, 提升效率.


### Hub和交换机对比

- 集线器属于OSI的地一层物理层设备, 而网桥属于OSI的第二层数据链路层设备
- 从工作方式看, 集线器是一种广播模式, 所有端口在一个冲突域里面. 网桥则可以通过端口隔离冲突
- Hub是所有共享总线和共享带宽. 网桥每个端口占一个带宽

## 路由器(router)

路由器工作在网络层

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235709.png)


为了实现路由, 路由器需要做下列事情:
- 分割广播域: 广播数据发送到路由器后, 不会被路由器转发到其他设备
- 选择路由表中到达目标最好的路径: 查看路由表命令`route -n`
- 维护和检查路由信息
- 连接广域网


![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235710.png)

路由: 把一个数据包从一个设备发送到不同网络里的另一个设备上去. 这些工作依靠路由器来完成. 路由器只关心网络的状态和决定网络中的最佳路径. 路由的实现依靠路由器中的路由表来完成.

由路由器隔开的两个网络称为两个网段. 因此说路由器是广域网设备, 而交换机是局域网设备. 局域网通信是基于广播机制, 而广域网通信是基于单播机制(点对点模式).

路由器可以与两个不同网段进行通讯, 是因为路由器实现了"网关"的功能.


网关(Gateway): 又称网间连接器, 协议转换器. 网关在网络层以上实现网络互联, 是复杂的网络互联设备, 仅用于两个高层协议不同的网络互联.网关既可以用于广域网互连, 也可以用于局域网互连. 网关是一种充当转换重任的计算机系统或设. 使用在不同的通信协议, 数据格式或语言, 甚至体系结构完全不同的两种系统之间, 网关是一个翻译器. 与网桥只是简单地传达信息不同, 网关对收到的信息要重新打包, 以适应目的系统的需求 网关的结构和路由器类似, 不同的是互连层. 路由器中一般包含多个网关. 每个网关可以与同在同一网段的机器进行通讯.

由于历史原因, 许多有关TCP/IP的文献曾经把网络层使用的路由器称为网关, 在今天很多局域网采用都是路由来接入网络, 因此通常指的网关就是路由器的IP.


**网段数量=2^可变网络ID位数**

**判断两个IP是否在同一网段, 即判断俩个IP的网络ID是否相同**

**网络ID=IP地址&子网掩码**

示例

1. IP地址为192.168.1.100, 子网掩码为255.255.255.0, 则网络ID为

   ```
   IP:         11000000 10101000 00000001 01100100
   netmask:    11111111 11111111 11111111 00000000
   网络ID:     11000000 10101000 00000001 00000000
   即    :        192      168      1        0
   ```

2. 判断172.20.222.123/20和172.20.230.100/20是否在同一网段

   ```
   172.20.222.123/20
   IP:        10101100 00010100 11011110 01111011
   netmask:   11111111 11111111 11110000 00000000
   netID:     10101100 00010100 11010000 00000000
   即:        172      20       208      0
   
   172.20.230.100/20
   IP:         10101100 00010100 11100110 01100100
   netmask:    11111111 11111111 11110000 00000000
   netID:      10101100 00010100 11100000 00000000
   即:         172      20       224      0
   
   网络ID不同, 因此不在同一网段
   ```

3. 判断192.168.1.100/16和192.168.2.100/24是否在一个网段

   ```
   1. A与B通讯, A使用自己的子网掩码和B的IP得到B的netID与A的netID进行比较
       A netID:    192.168.0.0
       
       B IP:       192.168.2.100
       A netmask:  255.255.0.0
       B netID:    192.168.0.0
   
   在同一网段
   
   2. B与A通讯, B使用自己的子网掩码和A的IP得到A的netID与B的netID进行比较
   
       B netID:    192.168.2.0
       
       A IP:       192.168.1.100
       B netmask:  255.255.255.0
       A netID:    192.168.1.0
   
   不在同一网段
   ```

## VLAN(虚拟局域网)

三层楼, 每层都有一个交换机, 负责把同层的办公电脑连接起来. 同时没一层都有销售部, 人事部, 工程部的员工. 希望各部门只能内部访问, 不能访问其他部门的主机. 此时即用到VLAN技术(Virtual Local Area Network), 虚拟局域网.

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235711.png)


可将两个VLAN的网络, 连接到一个路由器上, 然后通过路由器进行网络安全策略的设置. 同时, 如果有多个VLAN网络, 使用该方法, 则每一个VLAN网络均会占用一个接口, 比较浪费接口. 因此, 可以使用trunk的方式进行连接.

使用trunk进行广播数据包传输时, 会修改数据包, 在数据包中添加VLAN的信息, 使得接收方的交换机可以知道该数据包是发送给哪个VLAN网络的. 而通过trunk进行通讯的协议包括ISL(思科内部使用), 802.1Q(IEEE国际标准)

VLAN网络间的通讯, 需要使用路由进行连接, 如果是单个交换机中进行的vlan划分, 则只需要一根trunk线进行连接即可. 此时, VLAN10与VLAN20计算机间的通讯, 需要经过router进行转发, 而VLAN10或VLAN20内部计算机间的通讯不需要经过router.

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235712.png)

多交换机进行VLAN划分

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235713.png)


## 分层的网络结构

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235714.png)


从搭建网络角度划分

- 访问层/接入层: 普通的计算机接入到普通的交换机上
- 分布层: 普通交换机间使用路由器进行连接, 达到隔离广播域, 安全控制等功能
- 核心层: 实现快速转发. 当某一服务器需要被许多客户机访问时, 如果将其接入在普通交换机下, 会受普通交换机的性能限制, 使得访问速度慢, 因此将该服务器接入在高级交换机上, 达到对请求的快速转发的目的.


## TCP/IP协议栈

Transmission Control Protocol/Internet Protocol, 传输控制协议/因特网互联协议

- TCP/IP协议是一个Protocol Stack, 包括TCP, IP, UDP, ICMP, RIP, TELNET, FTP, SMTP, ARP等许多协议.

- 最早发源于美国国防部(缩写DoD)的因特网的前身ARPA网项目, 1983年1月1日, TCP/IP取代了旧的网络控制协议NCP, 成为今天互联网和局域网的基石和标准, 由互联网工程任务组负责维护

- 共定义了4层, 和ISO参考模型的分层有对应关系

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235715.png)

### TCP/IP协议栈分成与OSI参考模型对应关系

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235928.png)

### 常见网络协议与对应分层

linux查看所有协议命令: `cat /etc/services`

**Application应用层**

常见协议: http, https, ftp, nfs, dns, tftp, smtp, pop3, imap, telnet, ssh, QQ

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235716.png)


**Transport传输层**

常见协议: TCP, UDP

使用Application层协议对应的端口号标记上层协议类型

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235718.png)

**Internet网络层**

常见协议: IP

可靠性vs高效性

|                 |   Reliable(可靠)    |  Best-Effort(高效)  |
| :-------------: | :-----------------: | :-----------------: |
| Connection Type | Connection-oriented |   Connectionless    |
|    Protocol     |  TCP(传输控制协议)  | UDP(用户数据包协议) |
|   Sequencing    |   Yes(数据包有序)   |   No(数据包无序)    |
| Uses | E-mail, File sharing, Downloading | Voice streaming, Video streaming |


## TCP协议

### TCP特性

- 工作在传输层
- 面向连接: 需要提前与发送方建立连接
- 全双工
- 半关闭: 可以仅单向发送数据
- 错误检查
- 将数据打包成段, 排序
- 确认机制: 接收方是否成功接收到数据, 需要通知发送方
- 数据恢复, 重传
- 流量控制, 滑动窗口
- 拥塞控制, 慢启动和拥塞避免算法

### TCP包头

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235719.png)

- **源端口和目的端口**: 计算机上的进程要和其他进程通信是要通过计算机端口的, 而一个计算机端口某个时刻只能被一个进程占用, 所以通过指定源端口和目标端口, 就可以知道是哪两个进程需要通信. 其中源端口和目的端口各使用16bit表示的, 可推算计算机的端口个数为2^16=65536个. 
- **序号**: 表示本报文段所发送数据的第一个字节的编号. 在TCP连接中所传送的字节流的每一个字节都会按顺序编号. 由于序列号由32bit表示, 所以没2^32=4294967296个字节, 就会出现序号回绕, 再次从0开始.
- **确认号**: 表示接收方期望收到发送方下一个报文段的第一个字节数据的序号.
- **数据偏移**: 表示TCP报文段的首部长度, 共4bit. 由于TCP首部包含一个长度可变的选项部分, 需要指定这个TCP报文段到底有多长. 他指出TCP报文段的数据起始处距离TCP报文段的起始处有多远. 该字段的单位是32bit(4Byte),  4bit最大表示15, 多亿数据偏移也就是TCP首部最大值为60Byte.
- **URG**: 紧急位. 表示本报文段中是否包含紧急数据. 后面的紧急指针字段只有当URG=1时才有效
- **ACK**: 确认位. 表示前面的确认号是否有效. 只有当ACK=1时, 前面的确认才有效. TCP规定, 连接建立后, ACK必须为1, 带ACK标志的TCP报文段称为确认报文段
- **PSH**: 推位. 提示接收端应用程序应立即从TCP接收缓冲区中读走数据, 为接收后续数据腾出空间. 如果为1, 则表示对方应当立即把数据题交给上层应用, 而不是缓存起来, 如果应用程序不将接受到的数据读走, 就会一直停留在TCP接收缓冲区中.
- **RST**: 复位标志. 如果接收到RST=1的报文, 说明上次发送给主机的数据有问题, 主机拒绝响应, 
- **SYN**: 同步位. 在建立连接时使用, 用来同步序号. 当SYN=1, ACK=0时, 表示这是一个请求建立连接的报文段; 当SYN=1, ACK=1时, 表示对方同意建立连接. SYN=1, 说明这是一个请求建立连接或同意建立连接的报文. 只有在前两次握手中SYN才置为1, 带SYN标志的TCP报文段称为同步报文段
- **FIN**: 结束位. 表示通知对方本端要关闭连接了, 标记数据是否发送完毕. 如果FIN=1, 即告诉对方: "数据已经发送完毕, 你可以释放连接了", 带FIN标志的TCP报文段称为结束报文段

### TCP协议端口PORT

传输层通过port号, 确定应用层协议.

IANA: 互联网数字分陪机构(负责域名, 数字资源, 协议分配)
- 0-1023: 系统端口或特权端口(仅管理员可用), 众所周知, 永久的分配给固定的应用使用. 例如: 22/tcp(ssh), 80/tcp(http), 443/tcp(https), 21/tcp(ftp), 23/tcp(telnet), 53/tcp/udp(dns), 69/tcp(tftp), 161/udp(snmp), 25/(smtp), 110/(pop3), 142/(imap)
- 1024-49151: 用户端口或注册端口, 但要求并不严格, 分配给程序注册为某应用使用. 例如: 1433/tcp(SqlServer), 1521/tcp(oracle), 3306/tcp(mysql), 11211/tcp/udp(memcached)
- 49152-65535: 动态端口或私有端口, 客户端程序随机使用的端口
- 自定义随机端口号范围: `vim /proc/sys/net/ipv4/ip_local_port_range`

### TCP三次握手

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235720.png)

1. A机器发出一个数据包并将SYN置为1, 表示希望建立连接. 这个包中的序列号假设是x
2. B机器收到A机器发过来的数据包后, 通过SYN得知这是一个建立连接的请求, 于是发送一个响应包并将SYN和ACK标记都置为1. 假设这个包中的序列号是y, 而确认序号必须是x+1, 表示收到了A发过来的SYN.
3. A收到B的响应包后需进行确认, 确认包中将ACK置为1, 并将确认序号设置为y+1, 表示收到了来自B的SYN.

三次握手确认的信息

![image](https://gitee.com/swang-harbin/pic-bed/raw/master/images/2021/20210607235722.png)

## https://edu.aliyun.com/lesson_1358_11677#_11677


IEEE 802.3(以太网协议)
IEEE 802.a 802.b 802.n 802.ac(无线网协议) 物理层及数据链路层
802.11

查看网卡属性
`mii-tool -v eth0`或``ethtool eth0`

网卡工作在物理层和数据链路层

双绞线: 物理层
wifi(802.11), ppoe, ppp, ethernet, switch: 数据链路层
