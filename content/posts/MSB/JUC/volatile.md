---
title: volatile 与 CAS
date: '2020-07-04 00:00:00'
tags:
- MSB
- JUC
- Java
---
# volatile 与 CAS

A，B 两个线程都要使用到一个共享变量，Java 默认是在 A，B 线程中均保留一份 copy，这样，如果 B 线程对该变量进行了修改，A 线程未必会知道，
使用 volatile，可以让所有线程得到被修改的值（保证线程可见性）


## volatile 的作用

**1. 保证线程可见性**

HotSpot 虚拟机中堆内存是线程共享的，同时每个线程都有自己的工作区域，当线程对共享内存中的数据进行操作时，
是先将其 copy 到自己的工作区域中一份，然后先在自己工作区域对该数据进行修改，然后再写会共享区域，这就可能出现，
A 线程对数据进行了修改，但是还没有写回堆内存，B 线程就已经读取了旧的数据，这是不可行的，使用 volatile 可以保证
A 线程对数据进行了修改，其他线程立马可以对自己工作区域的数据进行更新。

该特性的本质是依赖于 CPU 底层的**缓存一致性协议（MESI）**

**2. 禁止指令重排序**

CPU 早期的时候对指令是一条一条按顺序执行的，现代 CPU 为了提高效率，会把指令并发的执行，即一条指令执行一半，就去执行另一条指令了，
这叫做流水线式的执行。

[Double Check Lock](/src/main/java/我爱你/王硕/c006_volatileandcas/d02_singleton)
